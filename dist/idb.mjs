var e={d:(t,r)=>{for(var s in r)e.o(r,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:r[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{aZ:()=>n,OP:()=>a,Fj:()=>o,Ay:()=>c,ho:()=>u,rE:()=>r});const r="0.0.1";function s(e){return new Promise(((t,r)=>{e.onsuccess=()=>{t(e.result)},e.onerror=()=>{r(e.error??e.transaction?.error??new Error("Request failed."))}}))}class n{name;upgReqs=[];upgIReqs=Object.create(null);reqs=[];isCommitRequested=!1;constructor(e){this.name=e}async open(e,t,r){const n=indexedDB.open(this.name,t);r&&(n.onupgradeneeded=()=>{r(n.result,n.transaction)});try{return await e(await s(n))}finally{n.result.close()}}transaction(e,t,r,s){let n;return new Promise(((i,o)=>{const a=e.transaction(t,r);a.oncomplete=()=>{i(n)},a.onerror=()=>{o(a.error??new Error("Transaction failed."))};try{n=s(a)}catch(e){throw a.abort(),e}}))}addUpgIRec(e,t){this.upgIReqs[e]||(this.upgIReqs[e]=[]),this.upgIReqs[e].push(t)}version(){return this.open((e=>e.version))}objectStoreNames(){return this.open((e=>e.objectStoreNames))}objectStore(e,t,r){if(this.upgReqs.push([e,"create",r=>{r.objectStoreNames.contains(e)||(t?r.createObjectStore(e,t):r.createObjectStore(e))}]),r)for(const t of r)this.addUpgIRec(e,[t.name,"create",e=>{e.indexNames.contains(t.name)||e.createIndex(t.name,t.keyPath,t.options)}]);return new o(this,e,e)}deleteObjectStore(e){return this.upgReqs.push([e,"delete",t=>{t.objectStoreNames.contains(e)&&t.deleteObjectStore(e)}]),this.commit()}deleteIndex(e,t){return this.addUpgIRec(e,[t,"delete",e=>{e.indexNames.contains(t)&&e.deleteIndex(t)}]),this.commit()}isNeedToUpg(e){for(const[t,r]of this.upgReqs){const s=e.objectStoreNames.contains(t);if("create"===r&&!s)return!0;if("delete"===r&&s)return!0}return!1}async isNeedToIUpg(e){const t=Object.keys(this.upgIReqs);return!!t.length&&this.transaction(e,t,"readonly",(e=>{for(const r of t){const t=e.objectStore(r);for(const[e,s]of this.upgIReqs[r]){const r=t.indexNames.contains(e);if("create"===s&&!r)return!0;if("delete"===s&&r)return!0}}return!1}))}async requestToCommit(e){e&&this.reqs.push(e),this.isCommitRequested||(this.isCommitRequested=!0,await Promise.resolve(),this.isCommitRequested=!1,await this.commit())}async commit(){let e=0;this.upgReqs.length&&(e=await this.open((async e=>this.isNeedToUpg(e)||await this.isNeedToIUpg(e)?e.version+1:(this.upgReqs=[],this.upgIReqs=Object.create(null),await this.processReqs(e),0)))),(this.reqs.length||this.upgReqs.length)&&(this.upgReqs.length?await this.open((e=>this.processReqs(e)),e,((e,t)=>{t&&this.processUpgReqs(e,t)})):await this.open((e=>this.processReqs(e))))}processUpgReqs(e,t){for(const[,,t]of this.upgReqs)t(e);this.upgReqs=[];for(const[e,r]of Object.entries(this.upgIReqs)){const s=t.objectStore(e);for(const[,,e]of r)e(s)}this.upgIReqs=Object.create(null)}async processReqs(e){if(!this.reqs.length)return;const t=[...new Set(this.reqs.map((([e])=>e)))],r=this.reqs.every((([,e])=>"readonly"===e))?"readonly":"readwrite";await this.transaction(e,t,r,(e=>{for(const[,,t]of this.reqs)t(e);this.reqs=[]}))}deleteDatabase(){return s(indexedDB.deleteDatabase(this.name))}}class i{db;osName;name;constructor(e,t,r){this.db=e,this.osName=t,this.name=r}register(e,t){return new Promise(((r,s)=>{this.db.requestToCommit([this.osName,e,e=>{try{r(t(this.getTarget(e)))}catch(e){s(e)}}]).catch((e=>{s(e)}))}))}registerQuery(e,t){return this.register(e,(e=>s(t(e))))}async*registerCursor(e,t){yield*await this.register(e,(e=>async function*(e){for(let t;t=await s(e);)yield t}(t(e))))}keyPath(){return this.register("readonly",(e=>e.keyPath))}count(e){return this.registerQuery("readonly",(t=>t.count(e)))}get(e){return this.registerQuery("readonly",(t=>t.get(e)))}getAll(e,t){return this.registerQuery("readonly",(r=>r.getAll(e,t)))}getAllKeys(e,t){return this.registerQuery("readonly",(r=>r.getAllKeys(e,t)))}getKey(e){return this.registerQuery("readonly",(t=>t.getKey(e)))}openCursor(e,t){return this.registerCursor("readwrite",(r=>r.openCursor(e,t)))}openKeyCursor(e,t){return this.registerCursor("readwrite",(r=>r.openKeyCursor(e,t)))}}class o extends i{getTarget(e){return e.objectStore(this.name)}autoIncrement(){return this.register("readonly",(e=>e.autoIncrement))}add(e,t){return this.registerQuery("readwrite",(r=>r.add(e,t)))}clear(){return this.registerQuery("readwrite",(e=>e.clear()))}delete(e){return this.registerQuery("readwrite",(t=>t.delete(e)))}index(e){return new a(this.db,this.name,e)}deleteIndex(e){return this.db.deleteIndex(this.name,e)}indexNames(){return this.register("readonly",(e=>e.indexNames))}put(e,t){return this.registerQuery("readwrite",(r=>r.put(e,t)))}}class a extends i{getTarget(e){return e.objectStore(this.osName).index(this.name)}multiEntry(){return this.register("readonly",(e=>e.multiEntry))}unique(){return this.register("readonly",(e=>e.unique))}}function u(e){return new n(e)}const c={open:u};var h=t.aZ,d=t.OP,l=t.Fj,g=t.Ay,p=t.ho,m=t.rE;export{h as Idb,d as IdbIndex,l as IdbStore,g as default,p as open,m as version};